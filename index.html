<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cashflow Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background: #f8f9fa;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    .summary {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .summary h2 {
      margin-top: 0;
    }
    .transaction-form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .transaction-form input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .transaction-form button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-income {
      background: #28a745;
      color: white;
    }
    .btn-expense {
      background: #dc3545;
      color: white;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #fff;
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filters button {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    .delete-btn {
      background: transparent;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 16px;
    }
    canvas {
      max-width: 100%;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>Cashflow Tracker</h1>

  <div class="summary">
    <h2>Summary</h2>
    <p>Income: <span id="income">0</span></p>
    <p>Expense: <span id="expense">0</span></p>
    <p>Balance: <span id="balance">0</span></p>
  </div>

  <div class="filters">
    <button onclick="setGrouping('all')">All</button>
    <button onclick="setGrouping('bi-monthly')">Bi-Monthly</button>
    <button onclick="setGrouping('monthly')">Monthly</button>
  </div>

  <form id="transaction-form" class="transaction-form">
    <input type="number" id="amount" placeholder="Amount" required min="1">
    <input type="text" id="note" placeholder="Note">
    <button type="button" class="btn-income" onclick="handleSubmit('income')">Income</button>
    <button type="button" class="btn-expense" onclick="handleSubmit('expense')">Expense</button>
  </form>

  <ul id="transaction-list"></ul>

  <canvas id="cashflowChart"></canvas>

  <script>
    const repo = "mykael25/cashflow-tracker";
    const filePath = "data/transactions.json";
    const apiUrl = `https://api.github.com/repos/${repo}/contents/${filePath}`;

    let token = localStorage.getItem("gh_token");
    if (!token) {
      token = prompt("Enter your GitHub Personal Access Token:");
      localStorage.setItem("gh_token", token);
    }

    let transactions = [];
    let currentGrouping = "all";
    let chartInstance = null;

    async function fetchTransactions() {
      let res = await fetch(apiUrl, {
        headers: { Authorization: `token ${token}` },
      });

      if (res.status === 200) {
        let data = await res.json();
        const content = atob(data.content.replace(/\n/g, ""));
        return { sha: data.sha, transactions: JSON.parse(content) };
      } else if (res.status === 404) {
        return { sha: null, transactions: [] };
      } else if (res.status === 401) {
        alert("Invalid token. Please re-enter.");
        localStorage.removeItem("gh_token");
        location.reload();
      }

      return { sha: null, transactions: [] };
    }

    async function saveTransactions(transactions, sha) {
      const updatedContent = btoa(JSON.stringify(transactions, null, 2));
      let res = await fetch(apiUrl, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          message: "Update transactions.json",
          content: updatedContent,
          sha: sha,
        }),
      });
      return res.json();
    }

    async function handleSubmit(type) {
      const amount = document.getElementById("amount").value;
      const note = document.getElementById("note").value;

      if (!amount || amount <= 0) {
        alert("Please enter a valid amount");
        return;
      }

      const { sha, transactions: current } = await fetchTransactions();
      current.push({ amount: parseFloat(amount), type, note, date: new Date().toISOString() });

      const result = await saveTransactions(current, sha);
      transactions = current;
      renderTransactions();
      updateSummary();
      updateChart();

      document.getElementById("transaction-form").reset();
    }

    function deleteTransaction(index) {
      transactions.splice(index, 1);
      saveTransactions(transactions, null).then(() => {
        renderTransactions();
        updateSummary();
        updateChart();
      });
    }

    function setGrouping(mode) {
      currentGrouping = mode;
      renderTransactions();
      updateSummary();
      updateChart();
    }

    function renderTransactions() {
      const list = document.getElementById("transaction-list");
      list.innerHTML = "";
      transactions.forEach((t, i) => {
        const li = document.createElement("li");
        li.textContent = `${t.type.toUpperCase()}: ${t.amount} - ${t.note}`;
        const delBtn = document.createElement("button");
        delBtn.textContent = "âœ•";
        delBtn.className = "delete-btn";
        delBtn.onclick = () => deleteTransaction(i);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    function updateSummary() {
      let income = 0, expense = 0;
      let filtered = groupTransactions(transactions);

      filtered.forEach(t => {
        if (t.type === "income") income += t.amount;
        else expense += t.amount;
      });

      document.getElementById("income").textContent = income;
      document.getElementById("expense").textContent = expense;
      document.getElementById("balance").textContent = income - expense;
    }

    function groupTransactions(data) {
      if (currentGrouping === "all") return data;
      const grouped = [];
      const map = {};
      data.forEach(t => {
        const d = new Date(t.date);
        let key;
        if (currentGrouping === "monthly") {
          key = `${d.getFullYear()}-${d.getMonth()+1}`;
        } else if (currentGrouping === "bi-monthly") {
          const half = d.getDate() <= 15 ? "H1" : "H2";
          key = `${d.getFullYear()}-${d.getMonth()+1}-${half}`;
        }
        if (!map[key]) map[key] = [];
        map[key].push(t);
      });
      Object.values(map).forEach(arr => grouped.push(...arr));
      return grouped;
    }

    function updateChart() {
      const ctx = document.getElementById("cashflowChart").getContext("2d");

      if (chartInstance) {
        chartInstance.destroy();
      }

      const labels = [];
      const incomeData = [];
      const expenseData = [];

      const grouped = groupTransactions(transactions);

      grouped.forEach(t => {
        const label = new Date(t.date).toLocaleDateString();
        if (!labels.includes(label)) labels.push(label);
      });

      labels.forEach(label => {
        let inc = 0, exp = 0;
        transactions.forEach(t => {
          if (new Date(t.date).toLocaleDateString() === label) {
            if (t.type === "income") inc += t.amount;
            else exp += t.amount;
          }
        });
        incomeData.push(inc);
        expenseData.push(exp);
      });

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Income", data: incomeData, backgroundColor: "green" },
            { label: "Expense", data: expenseData, backgroundColor: "red" }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    (async () => {
      const { transactions: t } = await fetchTransactions();
      transactions = t;
      renderTransactions();
      updateSummary();
      updateChart();
    })();
  </script>
</body>
</html>
